---
name: multi-ai-workflow
description: |
  完整的软件开发自动化工作流：需求分析→代码实现→代码审查。
  使用场景：开发新功能、创建新项目、实现完整模块、多AI协作开发。
  工作流：Claude分析需求并生成文档 → 调用Codex CLI实现代码 → 调用Gemini CLI审查代码。
  关键词：开发新功能、创建项目、实现功能、完整开发、多AI协作、需求分析、代码实现
license: Apache 2.0
metadata:
  version: 1.1.0
  author: User Custom
---

# 多 AI 协作工作流

使用 Claude、Codex 和 Gemini 三个 AI 协作完成从需求分析到代码审查的完整开发流程。

---

## 重要约束 (CRITICAL CONSTRAINTS)

### Claude 的角色定位

作为工作流协调者，Claude (你) 的职责是：
- ✅ **负责**：需求分析、文档生成、流程协调、用户交互、结果展示
- ❌ **不负责**：直接编写项目代码、直接进行代码审查

### 严格禁止事项

⚠️ **禁止直接编写代码**：在 Step 3 中，你 **不能** 使用自己的编码能力来实现用户需求。

⚠️ **必须调用外部工具**：编码和审查 **必须** 通过 Bash 工具调用外部 CLI 完成。

### 工具调用要求

当需要 Codex 编码或 Gemini 审查时：
1. **必须** 使用 Bash 工具执行脚本：`bash ~/.claude/skills/multi-ai-workflow/scripts/call_codex.sh`
2. **不能** 使用 Write 或 Edit 工具直接生成项目代码
3. **必须** 同步等待脚本执行完成并检查退出码 ($?)
4. **只能** 在生成需求文档和设计文档时使用 Write 工具

## 工作流概览

```
用户输入需求
    ↓
[Claude] 需求分析 + 生成文档
    ↓ (自动保存到 requirements/项目名/)
    ↓
[Codex] 执行编码
    ↓ (同步阻塞,检测 $?)
    ├─ 成功 → 展示代码 → 询问用户
    └─ 失败 → 展示错误 → [重试/修改/终止]
    ↓ (用户确认)
[Gemini] 代码审查
    ↓ (生成报告)
展示审查结果 → 询问用户 [优化/接受/结束]
```

---

## Step 1: 项目初始化

### 执行内容

1. 询问用户项目名称
2. 调用创建目录脚本
3. 确认目录创建成功

### 用户交互

询问用户:
```
欢迎使用多 AI 协作工作流！

此工作流将协调 Claude、Codex 和 Gemini 三个 AI 完成:
✓ 需求分析和文档生成 (Claude)
✓ 代码实现 (Codex)
✓ 代码审查和优化建议 (Gemini)

请输入项目名称(使用英文和连字符,例如: user-management-api):
```

### 脚本调用

获取项目名称后,执行:
```bash
bash ~/.claude/skills/multi-ai-workflow/scripts/create_project_dir.sh "项目名称"
```

检查退出码:
- 如果 $? = 0: 显示成功信息,继续 Step 2
- 如果 $? ≠ 0: 显示错误,询问重试或取消

### 输出格式

成功:
```
✓ 项目目录创建成功

目录结构:
  📁 requirements/项目名/  - 存放文档
  📁 当前工作目录          - 存放代码

准备开始需求分析...
```

失败:
```
✗ 目录创建失败

错误信息: [错误详情]

建议操作:
- 检查目录写入权限
- 确认项目名称格式正确
- 查看是否已存在同名项目

是否重试? [是] [取消]
```

---

## Step 2: 需求分析 (Claude 自动执行)

### 执行内容

作为 Claude,你需要:

1. **深入理解用户需求**
   - 分析用户输入的功能描述
   - 识别核心功能和技术要求
   - 提取关键业务逻辑
   - 必要时询问用户澄清细节

2. **生成需求文档** (`requirements/项目名/需求文档.md`)

   文档必须包含:
   - **项目概述**: 背景、目标、范围
   - **功能需求**: 详细的功能列表,每个功能包含描述、优先级、验收标准
   - **非功能需求**: 性能、安全、可用性要求
   - **数据要求**: 数据实体和关系
   - **外部接口**: API接口、第三方集成
   - **约束条件**: 技术、业务、时间约束
   - **验收标准**: 明确的完成标准

   参考模板位置: `~/.claude/skills/multi-ai-workflow/references/document_templates.md`

3. **生成详细技术设计** (`requirements/项目名/详细设计.md`)

   文档必须包含:
   - **系统架构**: 整体架构图和说明
   - **技术栈选择**: 语言、框架、数据库及选型理由
   - **模块设计**: 每个模块的职责、输入输出、核心类函数
   - **接口设计**: 内部接口和外部API的详细规范
   - **数据模型**: 数据库设计、表结构、索引
   - **核心算法**: 关键算法的伪代码和复杂度分析
   - **安全设计**: 认证、授权、数据加密方案
   - **性能优化**: 缓存策略、并发处理
   - **错误处理**: 异常分类和日志策略
   - **测试策略**: 单元测试、集成测试要求
   - **项目结构**: 目录结构和文件说明

   参考模板位置: `~/.claude/skills/multi-ai-workflow/references/document_templates.md`

4. **保存文档到指定位置**

   使用 Write 工具保存:
   - `requirements/项目名/需求文档.md`
   - `requirements/项目名/详细设计.md`

5. **生成文档摘要给用户确认**

### 文档质量标准

生成的文档必须:
- ✓ 内容完整,覆盖所有必要章节
- ✓ 描述清晰,Codex 能够直接理解和实现
- ✓ 技术细节充分,包含具体的接口定义、数据结构
- ✓ 包含示例代码片段(如适用)
- ✓ 验收标准明确,可测试
- ✓ 符合 Markdown 格式规范

### 用户交互

展示给用户:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 需求分析完成

【需求文档摘要】
- 核心功能: X 个
- 技术栈: [语言], [框架], [数据库]
- 预估复杂度: [低/中/高]
- 关键功能点:
  1. [功能1描述]
  2. [功能2描述]
  3. [...]

【详细设计摘要】
- 系统架构: [架构模式]
- 模块数量: Y 个
- 主要接口: Z 个
- 数据表: N 个

文档已保存到:
📄 requirements/项目名/需求文档.md
📄 requirements/项目名/详细设计.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

是否确认开始编码?
[确认] - 开始调用 Codex 编码
[修改需求] - 重新编辑需求文档
[查看文档] - 显示完整文档内容
[取消] - 终止工作流
```

### 处理用户响应

- **[确认]**: 进入 Step 3
- **[修改需求]**: 询问用户具体修改内容,重新生成文档
- **[查看文档]**: 显示完整文档内容,再次询问确认
- **[取消]**: 终止工作流,保留已生成文档

---

## Step 3: 调用 Codex CLI 进行编码 (条件触发)

### ⚠️ 重要提醒

**你(Claude)在此步骤中的角色**：
- ✅ 构建提示词
- ✅ 调用 Codex CLI (通过 Bash 工具执行脚本)
- ✅ 等待执行完成
- ✅ 检查结果和错误处理
- ❌ **绝对禁止**：直接使用 Write/Edit 工具编写项目代码
- ❌ **绝对禁止**：自己实现用户需求的代码

**编码工作由 Codex 完成，你只负责调用和协调。**

### 触发条件

用户在 Step 2 选择 [确认] 后自动执行

### 执行内容

1. **构建 Codex 提示词**

   提示词包含:
   - 需求文档路径
   - 设计文档路径
   - 实现要求(模块化、注释、错误处理、测试)
   - 输出目录(当前工作目录)

2. **调用 Codex CLI (必须使用 Bash 工具)**

   ⚠️ **关键要求**：
   - **必须** 使用 Bash 工具执行脚本，不能自己编写代码
   - **必须** 同步等待脚本执行完成
   - **必须** 检查退出码 ($?) 判断成功或失败

   执行脚本:
   ```bash
   bash ~/.claude/skills/multi-ai-workflow/scripts/call_codex.sh \
     "项目名称" \
     "requirements/项目名/需求文档.md" \
     "当前工作目录路径"
   ```

3. **同步等待执行完成**

   显示进度信息:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   正在调用 Codex 进行编码...

   项目: 项目名称
   需求文档: requirements/项目名/需求文档.md
   设计文档: requirements/项目名/详细设计.md
   输出目录: 当前工作目录

   ⏳ Codex 正在编码,请稍候...
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

4. **检查执行结果**

   检查 $? 退出码:
   - 如果 = 0: 执行成功处理流程
   - 如果 ≠ 0: 执行失败处理流程

### 成功处理流程

1. **统计生成的文件**

   ```bash
   # 列出新生成的文件
   find . -type f -newer requirements/项目名/需求文档.md -not -path "*/\.*"

   # 统计代码行数
   find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" \) \
     -newer requirements/项目名/需求文档.md -exec wc -l {} +
   ```

2. **展示成功信息**

   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✓ Codex 编码完成！

   生成的文件:
   📁 src/
     ├── main.py (145 行)
     ├── models.py (89 行)
     ├── utils.py (67 行)
     └── config.py (34 行)
   📁 tests/
     └── test_main.py (112 行)
   📄 requirements.txt
   📄 README.md

   统计信息:
   - 总文件数: 7
   - 总代码行数: 447
   - 测试文件: 1

   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   代码已成功生成,准备进入代码审查阶段...
   ```

3. **自动进入 Step 4**

### 失败处理流程

1. **捕获错误信息**

   从脚本输出获取:
   - 完整的错误输出(stdout + stderr)
   - 退出码
   - 错误发生的时间

2. **分析错误原因**

   根据错误信息和退出码分析可能原因:
   - 网络问题 (连接超时、DNS解析失败)
   - API限流 (429错误码)
   - 认证失败 (401/403错误)
   - 需求不明确 (Codex无法理解)
   - 权限问题 (无法写入文件)
   - 其他系统错误

3. **展示错误界面**

   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✗ Codex 执行失败

   错误信息:
   [完整的错误输出内容]

   错误码: [退出码]

   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   可能原因分析:
   1. [根据错误分析的原因1]
   2. [原因2]
   3. [...]

   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   建议操作:
   ✓ [具体建议1]
   ✓ [具体建议2]
   ✓ [...]

   参考: 查看 ~/.claude/skills/multi-ai-workflow/references/error_troubleshooting.md

   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   您希望如何处理?
   [重试] - 使用相同参数重新执行
   [修改需求后重试] - 返回 Step 2 修改需求文档
   [终止流程] - 结束工作流
   ```

4. **处理用户响应**

   - **[重试]**: 重新执行 call_codex.sh,回到本步骤开始
   - **[修改需求后重试]**: 返回 Step 2
   - **[终止流程]**: 结束工作流,保留所有已生成内容

---

## Step 4: 用户确认审查 (交互节点)

### 触发条件

Codex 编码成功后自动进入

### 执行内容

展示代码摘要,询问用户是否继续审查

### 用户交互

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ Codex 已完成编码

生成的代码:
- [文件列表和行数统计]
- 总计: X 个文件, Y 行代码

代码摘要:
- 实现了 [功能列表]
- 使用技术: [技术栈]
- 测试覆盖: [有/无]
- 项目结构: [目录结构简述]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

下一步操作:

[是,立即审查] - 调用 Gemini 进行代码审查
[否,我先检查代码] - 暂停流程,稍后手动触发审查
[结束流程] - 接受当前代码,结束工作流
```

### 处理用户响应

- **[是,立即审查]**: 进入 Step 5
- **[否,我先检查代码]**: 暂停工作流,提示用户如何恢复
- **[结束流程]**: 显示总结信息,结束工作流

暂停提示:
```
工作流已暂停

您可以:
1. 检查生成的代码文件
2. 手动测试或修改代码
3. 准备好后,重新运行此 skill 并选择"继续审查"

文档位置: requirements/项目名/
代码位置: 当前工作目录

若要继续审查,请再次调用此 skill 并选择继续。
```

---

## Step 5: 调用 Gemini CLI 进行审查 (条件触发)

### ⚠️ 重要提醒

**你(Claude)在此步骤中的角色**：
- ✅ 调用 Gemini CLI (通过 Bash 工具执行脚本)
- ✅ 等待执行完成
- ✅ 读取和解析审查报告
- ✅ 展示结果给用户
- ❌ **绝对禁止**：自己进行代码审查
- ❌ **绝对禁止**：使用自己的能力分析代码质量

**代码审查工作由 Gemini 完成，你只负责调用和展示结果。**

### 触发条件

用户在 Step 4 选择 [是,立即审查] 后执行

### 执行内容

1. **调用 Gemini CLI (必须使用 Bash 工具)**

   ⚠️ **关键要求**：
   - **必须** 使用 Bash 工具执行脚本
   - **必须** 同步等待脚本执行完成
   - **必须** 检查退出码 ($?) 判断成功或失败

   执行脚本:
   ```bash
   bash ~/.claude/skills/multi-ai-workflow/scripts/call_gemini.sh \
     "项目名称" \
     "当前工作目录路径" \
     "requirements/项目名/代码审查报告.md"
   ```

2. **同步等待执行完成**

   显示进度:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   正在调用 Gemini 进行代码审查...

   审查范围: 当前工作目录
   输出报告: requirements/项目名/代码审查报告.md

   ⏳ Gemini 正在分析代码,请稍候...
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

3. **检查执行结果**

   检查 $? 退出码:
   - 如果 = 0: 读取报告,进入 Step 6
   - 如果 ≠ 0: 展示错误,询问处理方式

### 成功处理流程

1. **读取审查报告**

   使用 Read 工具读取: `requirements/项目名/代码审查报告.md`

2. **解析报告内容**

   提取关键信息:
   - 整体评分
   - 严重问题数量和描述
   - 警告数量和描述
   - 优化建议数量

3. **进入 Step 6 展示结果**

### 失败处理流程

展示错误界面:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✗ Gemini 执行失败

错误信息:
[完整错误输出]

错误码: [退出码]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
可能原因:
1. [错误原因分析]
2. [...]

建议操作:
✓ [具体建议]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

您希望如何处理?
[重试] - 重新调用 Gemini 审查
[跳过审查] - 接受当前代码,结束流程
[终止流程] - 结束工作流
```

处理响应:
- **[重试]**: 重新执行 call_gemini.sh
- **[跳过审查]**: 直接显示总结,结束工作流
- **[终止流程]**: 结束工作流

---

## Step 6: 结果展示和优化决策 (交互节点)

### 触发条件

Gemini 审查成功完成后

### 执行内容

1. **展示审查结果摘要**

   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✓ Gemini 代码审查完成

   审查结果摘要:
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   整体评分: X.X/10

   发现问题统计:

   🔴 严重问题: N 个
     - [问题1描述] (文件:行号)
     - [问题2描述] (文件:行号)
     - [...]

   🟡 警告: M 个
     - [警告1描述] (文件:行号)
     - [警告2描述] (文件:行号)
     - [...]

   🟢 优化建议: K 个
     - [建议1描述]
     - [建议2描述]
     - [...]

   详细报告位置:
   📄 requirements/项目名/代码审查报告.md

   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

2. **询问用户处理方式**

   ```
   您希望如何处理?

   [让 Codex 优化] - 将审查意见反馈给 Codex,自动优化代码
   [我自己修改] - 结束自动流程,手动修改代码
   [查看详细报告] - 显示完整的审查报告内容
   [接受当前代码] - 确认代码可用,结束工作流
   ```

### 处理用户响应

#### [让 Codex 优化]

1. 构建优化提示词:
   ```
   根据 Gemini 的代码审查报告(requirements/项目名/代码审查报告.md),
   优化当前目录的代码。

   重点修复:
   - 所有严重问题
   - 所有警告
   - 尽可能实现优化建议

   要求:
   1. 保持代码功能不变
   2. 改进代码质量和安全性
   3. 优化性能
   4. 更新注释和文档
   ```

2. 调用 Codex:
   ```bash
   bash ~/.claude/skills/multi-ai-workflow/scripts/call_codex.sh \
     "项目名称" \
     "requirements/项目名/代码审查报告.md" \
     "当前工作目录路径"
   ```

3. 成功后询问:
   ```
   ✓ Codex 已完成代码优化

   是否再次进行 Gemini 审查?
   [是] - 进入审查迭代
   [否] - 接受优化后的代码,结束流程
   ```

#### [我自己修改]

显示总结:
```
工作流结束

已生成的内容:
📄 requirements/项目名/需求文档.md
📄 requirements/项目名/详细设计.md
📄 requirements/项目名/代码审查报告.md
📁 当前目录代码文件

请根据审查报告手动优化代码。

感谢使用多 AI 协作工作流！
```

#### [查看详细报告]

使用 Read 工具读取并展示完整报告,然后再次询问处理方式

#### [接受当前代码]

显示最终总结:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 工作流完成

项目: 项目名称

生成的文档:
📄 requirements/项目名/需求文档.md
📄 requirements/项目名/详细设计.md
📄 requirements/项目名/代码审查报告.md

生成的代码:
📁 当前工作目录
- X 个文件
- Y 行代码
- Gemini 评分: Z/10

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

建议下一步:
1. 运行单元测试 (如已生成)
2. 手动测试核心功能
3. 根据实际使用调整配置
4. 部署到测试环境

感谢使用多 AI 协作工作流！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 错误处理通用原则

### 错误信息格式

所有错误都使用统一格式:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✗ [工具名称] 执行失败

错误信息:
[完整的错误输出,包括堆栈跟踪]

错误码: [exit code]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
可能原因分析:
1. [原因1]
2. [原因2]
3. [...]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
建议操作:
✓ [建议1]
✓ [建议2]
✓ [...]

参考: ~/.claude/skills/multi-ai-workflow/references/error_troubleshooting.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

您希望如何处理?
[选项1]
[选项2]
[...]
```

### 错误分类和建议

根据错误类型提供针对性建议,参考 `references/error_troubleshooting.md`

---

## 使用说明

### 启动工作流

在 Claude Code 中调用此 skill,输入你的需求描述,例如:
```
创建一个用户管理的 REST API,使用 Python Flask,
包含用户注册、登录、信息修改功能,使用 JWT 认证。
```

### 工作流特点

- ✅ **自动化主流程**: 文档生成后自动触发 Codex,Codex 成功后提示审查
- ✅ **关键节点确认**: 在文档确认、审查确认、优化决策等关键点需要用户确认
- ✅ **同步阻塞执行**: Codex 和 Gemini CLI 同步执行,通过 $? 检测结果
- ✅ **错误透明处理**: 失败时展示完整错误信息和可操作建议
- ✅ **目录结构统一**: 文档在 `requirements/项目名/`,代码在当前工作目录

### 目录结构

执行后会创建:
```
当前工作目录/
├── [生成的代码文件]
└── requirements/
    └── 项目名/
        ├── 需求文档.md
        ├── 详细设计.md
        └── 代码审查报告.md
```

---

## 参考资源

- **文档模板**: `~/.claude/skills/multi-ai-workflow/references/document_templates.md`
- **错误处理指南**: `~/.claude/skills/multi-ai-workflow/references/error_troubleshooting.md`

---

## 版本信息

- **版本**: 1.0.0
- **创建时间**: 2025-12-12
- **许可证**: Apache 2.0
